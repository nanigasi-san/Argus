# GeoJSON ↔ QRコード（完全オフライン）機能 要件定義書

最終更新: 2025-11-06 / 作成者: ChatGPT

---

## 0. 目的と背景
現地（通信圏外）でGeoJSON地理データを紙・端末間で交換するため、**完全オフライン**で動作する「QRコード生成機能」と「QRコード復元機能」を提供する。本書は両機能の要件を網羅的に定義し、設計・実装・テスト・運用の基準を与える。

---

## 1. 用語定義
- **GeoJSON**: IETF RFC 7946に準拠したJSON形式の地理空間データ。
- **QRテキスト**: QRコードに格納するUTF-8文字列。`<scheme>:<payload>`形式。
- **スキーム（scheme）**: 符号化・圧縮方式の識別子。例: `geojson`, `gjz1`, `gjz2`, `gjb1`, `gjz1p`。
- **完全オフライン**: 生成・復元の全工程がネットワーク接続なしで完結すること。
- **分割QR**: 1件のデータを複数のQRに分割し、復元時に結合する方式。

---

## 2. スコープ
- **対象**: GeoJSON→QR生成（単一/分割）, QR→GeoJSON復元（単一/分割）。
- **非対象**: 位置参照サービス, Web短縮URL, サーバ通信, クラウド保管。
- **利用環境**: デスクトップ/モバイル（OS不問）、カメラ/画面/印刷のローカル入出力のみ。

---

## 3. 前提・制約
- **前提**
  - 入出力ファイルはUTF-8（BOM無）。
  - 入力GeoJSONは妥当なJSON構造（`type`必須）。
  - 印刷/表示の物理品質は運用側で確保（最小モジュール0.3mm以上推奨）。
- **制約**
  - 通信禁止（完全オフライン）。
  - 依存ライブラリはローカル配布可能であること。
  - 端末の計算・メモリ資源に依存するため、圧縮や分割で調整可能であること。

---

## 4. ステークホルダ
- **利用者**: 調査員、イベント運営者、参加者、教育現場。
- **開発者**: アプリ/ライブラリ開発チーム。
- **運用者**: 印刷・配布・読み取り担当者。

---

## 5. 成果物（出力物）
- 機能仕様に準拠した**QR画像**（PNG推奨）
- 同内容の**QRテキスト**（プレーンテキスト）
- 復元された**GeoJSONファイル**（最小化済みでも可）
- （分割時）**マニフェスト**: 行単位で`gjz1p:`テキストを列挙

---

## 6. 機能要件（FR）

### FR-1: GeoJSON最小化
- 入力GeoJSONをパースし、`json.dumps(..., separators=(",", ":"))`相当で最小化する。
- 目的: 圧縮効率・ハッシュ安定性の向上。

### FR-2: スキーム別エンコード
- **`geojson:`**: プレーンUTF-8文字列をそのまま格納。小容量向け（≤2KB目安）。
- **`gjz1:`**: `gzip`圧縮 → Base64（URL-safe, `=`パディング省略）でエンコード。
- **`gjz2:`**: `gzip`圧縮 → Base45でエンコード（QR最適化）。
- **`gjb1:`**: `brotli`圧縮 → Base64（URL-safe）でエンコード。
- いずれも **`<scheme>:<payload>`** に連結し、ASCII互換の連続文字列とする。

### FR-3: 整合性オプション
- ハッシュ付与を選択可。形式: `...#<sha256_hex>`
- 対象は**圧縮前の最小化GeoJSON**。
- 復元時に一致検証（オプション）。

### FR-4: 分割QR（大容量対応）
- 単一QRに収まらない場合、**ペイロード文字列**を分割。
- 形式: `gjz1p:<index>/<total>:<chunkPayload>`
- `index`は1始まり。`total`は総分割数。最後の`chunkPayload`の末尾に`#hash`が入る場合あり。
- 復元時: `index`順に連結→`gjz1:`へ合成→通常デコード。

### FR-5: 復号処理
- 入力が`gjz1:`なら直接復号。`gjz1p:`複数行なら結合してから復号。
- Base64はパディングを自動補完。Base45にも対応（`gjz2`）。
- 圧縮展開に失敗した場合、適切なエラーを返却。

### FR-6: GeoJSON妥当性検査
- 復元後、`type`が`FeatureCollection`/`Feature`/`GeometryCollection`/`Point`/`LineString`/`Polygon`/`MultiPoint`/`MultiLineString`/`MultiPolygon`のいずれかであることを確認。

### FR-7: QR画像生成
- 誤り訂正レベル: 既定**Q**、選択肢にL/M/Q/H。
- バージョン自動。サイズ制約超過時は分割を促す/自動分割。
- 画像フォーマット: PNG（透過背景可）。
- 物理設計指針: モジュール≥0.3mm、余白（クワイエットゾーン）既定4モジュール。

### FR-8: 入出力I/O
- 入力: ファイル/標準入力、出力: ファイル/標準出力（テキスト/画像）。
- 分割時は連番ファイル命名（例: `qr_001.png`）とマニフェスト出力。

### FR-9: ロギング
- 成功/失敗、分割数、ハッシュ付与有無、出力先をINFOで記録。
- 例外はERRORで記録し終了コード非0。

### FR-10: ヘルプ/使用法表示
- CLIで`--help`により使用法を出す（言語非依存の設計指針）。

---

## 7. 非機能要件（NFR）

### NFR-1: 可搬性
- オフライン配布（zip等）でセットアップ可能。
- OS/アーキテクチャ非依存（実装言語が許す範囲）。

### NFR-2: 信頼性
- 分割結合での欠落/重複を厳密検出。
- ハッシュ照合（任意）でデータ完全性を担保。

### NFR-3: 性能
- 100点（Polygon想定）~ 数百点のGeoJSONを実用的時間でエンコード/デコード。
- 圧縮/展開は数秒以内を目安（端末性能に依存）。

### NFR-4: 使用性
- エラーメッセージは具体的・簡潔。
- 進行状況（分割数/現在インデックス）を表示可能。

### NFR-5: 保守性
- スキーム追加を疎結合で実装（戦略パターン相当）。
- ユニットテスト/サンプルデータを同梱。

### NFR-6: セキュリティ
- 既定は平文（暗号化なし）。
- 機密性が必要な場合、暗号化スキーム（`gjz1e:`等）を将来追加可能。

### NFR-7: 文書化
- 仕様・CLI使用例・制限事項・トラブルシュートを同梱READMEに記載。

---

## 8. エラー仕様（標準化コード）
| コード               | 事象           | 例                | 回復指針                          |
| -------------------- | -------------- | ----------------- | --------------------------------- |
| E_UNSUPPORTED_SCHEME | 未知スキーム   | `abc1:...`        | スキーム一覧提示/再エンコード促す |
| E_DECODE_FAILED      | Base系復号失敗 | 破損/誤読         | 再スキャン/原本照合               |
| E_DECOMPRESS_FAILED  | 圧縮展開失敗   | gzip/brotliエラー | スキーム誤り/データ破損           |
| E_INVALID_GEOJSON    | JSON妥当性NG   | `type`欠落        | 入力源見直し/再作成               |
| E_PAYLOAD_TOO_LARGE  | 単一QR超過     | Version上限超     | 分割有効化/簡略化                 |
| E_CHUNK_MISMATCH     | 分割不整合     | 欠落/重複         | 再読取/順序確認                   |

---

## 9. 容量と印刷設計ガイド
- 目安：最小化GeoJSON 100点 ≈ 4KB（素のJSON）。`gjz1`圧縮後 ≈ 1–2KB。
- 単一QRでの実運用は **2〜3KB** 程度までが安全域（誤り訂正Q, 品質良）。
- それ以上は分割QRを推奨。
- 物理印刷：A6でも可だが、読み取り距離を考慮してサイズ・コントラスト確保。

---

## 10. I/O仕様（ファイル/テキスト）
- **入力（エンコード）**: `.geojson`/`.json` or 標準入力（UTF-8）
- **出力（エンコード）**: `out.png`（単一時） or `out_dir/qr_###.png`（分割時） + `qr_texts.txt`
- **入力（デコード）**: `gjz1:` or `gjz1p:`の行群（ファイル/標準入力）
- **出力（デコード）**: `restored.geojson`（UTF-8）

---

## 11. ユースケース
1) **現地配布**: 主催側がコースGeoJSONをQR化し配布。参加者はスキャンしGeoJSONを復元。
2) **掲示物**: ポスター/看板に分割QRを掲載。現場で順に読み取り復元。
3) **端末間転送**: 画面表示→別端末カメラで読み取り→GeoJSON復元。

---

## 12. 品質保証（テスト計画）
- **単体**: 最小化、圧縮/展開、Base64/45、ハッシュ、分割/結合、QR生成の各関数。
- **結合**: `geojson → gjz1 → QR → gjz1 → geojson`往復同値性。
- **異常系**: スキーム不正、Base破損、欠落チャンク、順序入替、圧縮形式不一致。
- **負荷**: 1KB/2KB/4KB/8KB/16KBの代表パターン。
- **デバイス**: 主要解像度/画面輝度/印刷品質で読み取り試験。

---

## 13. 受け入れ基準（Acceptance Criteria）
- AC-1: 既知のGeoJSON（サンプル3件以上）で往復同値性が成立する。
- AC-2: 2KB, 4KB, 8KBケースで規定通りに単一/分割が選択される。
- AC-3: 分割欠落/重複時に`E_CHUNK_MISMATCH`を返す。
- AC-4: `--hash/--verify-hash`相当の整合性検証が成功/失敗で判定できる。
- AC-5: 誤り訂正Qで名刺サイズ相当の印刷から実機読み取りが可能。

---

## 14. セキュリティ/拡張計画
- 機微情報取り扱い時は暗号化スキーム（`gjz1e:`）を拡張導入。
- 署名（公開鍵）による改ざん検知は将来オプション（`gjz1s:`）として定義。

---

## 15. トラブルシューティング
- 読み取り不能: コントラスト/サイズ/汚れ/曲面を確認、誤り訂正レベルを上げる。
- データ超過: 分割を有効化、座標の桁数削減、TopoJSON化等を検討。
- ハッシュ不一致: 再スキャン、別媒体から復元、元データ再発行。

---

## 16. 変更管理（MoSCoW）
- **Must**: `gjz1`単一/分割、ハッシュ任意、復元、QR生成、エラーハンドリング。
- **Should**: `gjz2`（Base45）対応、マニフェスト自動出力、進行表示。
- **Could**: 署名/暗号化、TopoJSON/Polyline前処理、GUIランチャ。
- **Won't (v1)**: オンライン配布、短縮URL、サーバ連携。

---

## 17. リスクと対策
- **印刷品質リスク**: サンプルICC/出力チェックリストを配布。
- **端末差（カメラ/OS）**: 複数端末での受入テストを必須化。
- **データ膨張**: 圧縮/分割/桁数丸めの運用ガイドを提示。

---

## 18. 付録（参考フォーマット）
- 単一: `gjz1:<base64url_no_pad_of_gzip(minified_json)>[#<sha256>]`
- 分割: `gjz1p:<i>/<n>:<chunk>` （末尾チャンクに`#<sha256>`が含まれうる）
- 復元順序: `1..n`で連結→`gjz1:`に合成→通常デコード

---

以上。

